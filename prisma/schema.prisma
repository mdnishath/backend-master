// This is your Prisma schema file
// Learn more: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}


// ─── TENANT (Multi-tenancy) ────────────────────────────────────

model Tenant {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  isActive  Boolean  @default(true)
  settings  Json     @default("{}")
  users     User[]
  roles     Role[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("tenants")
}

// ─── USER ──────────────────────────────────────────────────────

model User {
  id                   String         @id @default(cuid())
  email                String
  password             String
  firstName            String?
  lastName             String?
  isActive             Boolean        @default(true)
  emailVerified        Boolean        @default(false)
  resetToken           String?
  resetTokenExpiresAt  DateTime?
  tenantId             String
  tenant               Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  roles                UserRole[]
  refreshTokens        RefreshToken[]
  createdAt            DateTime       @default(now())
  updatedAt            DateTime       @updatedAt

  @@unique([email, tenantId])
  @@index([tenantId])
  @@index([email])
  @@map("users")
}

// ─── ROLE ──────────────────────────────────────────────────────

model Role {
  id          String           @id @default(cuid())
  name        String
  description String?
  isSystem    Boolean          @default(false)
  tenantId    String
  tenant      Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  permissions RolePermission[]
  users       UserRole[]
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  @@unique([name, tenantId])
  @@index([tenantId])
  @@map("roles")
}

// ─── PERMISSION ────────────────────────────────────────────────

model Permission {
  id          String           @id @default(cuid())
  action      String
  resource    String
  description String?
  roles       RolePermission[]
  createdAt   DateTime         @default(now())

  @@unique([action, resource])
  @@map("permissions")
}

// ─── USER ↔ ROLE (Many-to-Many) ────────────────────────────────

model UserRole {
  userId    String
  roleId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  role      Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)
  assignedAt DateTime @default(now())

  @@id([userId, roleId])
  @@map("user_roles")
}

// ─── ROLE ↔ PERMISSION (Many-to-Many) ──────────────────────────

model RolePermission {
  roleId       String
  permissionId String
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId])
  @@map("role_permissions")
}

// ─── REFRESH TOKEN ─────────────────────────────────────────────

model RefreshToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([token])
  @@map("refresh_tokens")
}

// ─── AUDIT LOG ──────────────────────────────────────────────────

model AuditLog {
  id        String   @id @default(cuid())
  action    String
  resource  String
  resourceId String?
  userId    String?
  tenantId  String?
  metadata  Json     @default("{}")
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([tenantId])
  @@index([action, resource])
  @@index([createdAt])
  @@map("audit_logs")
}

// ─── FILE UPLOAD ────────────────────────────────────────────────

model FileUpload {
  id           String   @id @default(cuid())
  originalName String
  storagePath  String
  mimeType     String
  size         Int
  url          String
  uploadedBy   String
  tenantId     String
  createdAt    DateTime @default(now())

  @@index([uploadedBy])
  @@index([tenantId])
  @@map("file_uploads")
}

// ─── WEBHOOK SUBSCRIPTION (Phase 3) ────────────────────────────

model WebhookSubscription {
  id          String   @id @default(cuid())
  tenantId    String
  url         String
  events      String[] // Array of event names: user.created, file.uploaded, etc.
  secret      String   // For HMAC signature verification
  isActive    Boolean  @default(true)
  description String?
  createdBy   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([tenantId])
  @@index([isActive])
  @@map("webhook_subscriptions")
}

// ─── WEBHOOK DELIVERY LOG (Phase 3) ────────────────────────────

model WebhookDelivery {
  id             String   @id @default(cuid())
  webhookId      String
  event          String
  payload        Json
  url            String
  statusCode     Int?
  responseBody   String?
  error          String?
  attempts       Int      @default(1)
  deliveredAt    DateTime?
  createdAt      DateTime @default(now())

  @@index([webhookId])
  @@index([event])
  @@index([createdAt])
  @@map("webhook_deliveries")
}

// ─── FEATURE FLAG (Phase 3) ─────────────────────────────────────

model FeatureFlag {
  id          String   @id @default(cuid())
  key         String   // e.g., 'advanced-analytics', 'ai-features'
  name        String
  description String?
  isEnabled   Boolean  @default(false)
  tenantId    String?  // NULL = global flag, otherwise tenant-specific
  metadata    Json     @default("{}")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([key, tenantId])
  @@index([tenantId])
  @@index([isEnabled])
  @@map("feature_flags")
}

// ─── TENANT PLAN REMOVED (Open Source - No Paid Tiers) ─────────
// Settings are now in Tenant.settings JSON field:
// {
//   "rateLimit": 100,           // requests per minute (-1 = unlimited)
//   "maxUsers": -1,             // -1 = unlimited
//   "maxStorage": -1,           // bytes, -1 = unlimited
//   "maxWebhooks": -1,          // -1 = unlimited
//   "features": ["posts", "ecommerce", "notifications"]
// }

// ─── EMAIL TEMPLATE (Email System) ─────────────────────────────

model EmailTemplate {
  id          String   @id @default(cuid())
  tenantId    String?  // null = global template
  name        String   // "welcome", "password-reset", "invitation"
  subject     String
  htmlBody    String   @db.Text
  textBody    String?  @db.Text
  variables   Json     @default("{}") // {name: "string", email: "string", resetLink: "string"}
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([tenantId, name])
  @@index([tenantId])
  @@index([isActive])
  @@map("email_templates")
}

// ─── EMAIL LOG (Email Tracking) ────────────────────────────────

model EmailLog {
  id           String   @id @default(cuid())
  tenantId     String
  to           String
  from         String?
  subject      String
  templateName String?
  status       String   // "sent", "failed", "bounced", "delivered", "opened", "clicked"
  emailId      String?  // External email ID from provider
  error        String?  @db.Text
  metadata     Json     @default("{}")
  sentAt       DateTime @default(now())

  @@index([tenantId, sentAt])
  @@index([status])
  @@index([to])
  @@map("email_logs")
}

// ─── POST (CMS - Blog/News) ────────────────────────────────────

model Post {
  id            String    @id @default(cuid())
  tenantId      String
  authorId      String
  title         String
  slug          String
  excerpt       String?   @db.Text
  content       Json      // Rich text editor JSON (TipTap/Lexical)
  htmlContent   String?   @db.Text  // Rendered HTML for SEO
  featuredImage String?
  status        String    @default("draft") // "draft", "published", "scheduled"
  publishedAt   DateTime?
  scheduledFor  DateTime?
  views         Int       @default(0)

  // SEO
  metaTitle       String?
  metaDescription String?
  metaKeywords    String?
  ogImage         String?

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  categories    PostCategory[]
  tags          PostTag[]
  comments      Comment[]

  @@unique([tenantId, slug])
  @@index([tenantId, status, publishedAt])
  @@index([authorId])
  @@map("posts")
}

// ─── PAGE (CMS - Static Pages) ─────────────────────────────────

model Page {
  id            String    @id @default(cuid())
  tenantId      String
  authorId      String
  title         String
  slug          String
  content       Json      // Rich text editor JSON
  htmlContent   String?   @db.Text
  template      String?   // "default", "landing", "blank"
  status        String    @default("draft")
  publishedAt   DateTime?
  isHomePage    Boolean   @default(false)
  parentId      String?   // For nested pages
  order         Int       @default(0)

  // SEO
  metaTitle       String?
  metaDescription String?
  ogImage         String?

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  parent        Page?     @relation("PageHierarchy", fields: [parentId], references: [id])
  children      Page[]    @relation("PageHierarchy")

  @@unique([tenantId, slug])
  @@index([tenantId, status])
  @@index([authorId])
  @@map("pages")
}

// ─── CATEGORY ──────────────────────────────────────────────────

model Category {
  id          String   @id @default(cuid())
  tenantId    String
  name        String
  slug        String
  description String?
  parentId    String?  // For nested categories

  parent      Category? @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children    Category[] @relation("CategoryHierarchy")
  posts       PostCategory[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([tenantId, slug])
  @@index([tenantId])
  @@map("categories")
}

// ─── TAG ───────────────────────────────────────────────────────

model Tag {
  id          String   @id @default(cuid())
  tenantId    String
  name        String
  slug        String

  posts       PostTag[]

  createdAt   DateTime @default(now())

  @@unique([tenantId, slug])
  @@index([tenantId])
  @@map("tags")
}

// ─── POST ↔ CATEGORY (Many-to-Many) ────────────────────────────

model PostCategory {
  postId      String
  categoryId  String

  post        Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  category    Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@id([postId, categoryId])
  @@map("post_categories")
}

// ─── POST ↔ TAG (Many-to-Many) ─────────────────────────────────

model PostTag {
  postId      String
  tagId       String

  post        Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  tag         Tag      @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([postId, tagId])
  @@map("post_tags")
}

// ─── COMMENT ───────────────────────────────────────────────────

model Comment {
  id          String   @id @default(cuid())
  postId      String
  authorId    String?  // Null if guest comment
  authorName  String?  // For guest comments
  authorEmail String?  // For guest comments
  content     String   @db.Text
  status      String   @default("pending") // "pending", "approved", "spam"
  parentId    String?  // For nested replies

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  post        Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  parent      Comment? @relation("CommentReplies", fields: [parentId], references: [id])
  replies     Comment[] @relation("CommentReplies")

  @@index([postId, status])
  @@index([authorId])
  @@map("comments")
}
